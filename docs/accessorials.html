<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CW Czar Pricing | Accessorials</title>

  <!-- Use the same CSS & font as other pages -->
  <link rel="stylesheet" href="./styles.css?v=30" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Page-specific niceties (non-header) */
    .page-intro { text-align:center; color:#4b5563; margin-top:6px; }
    .card {
      border: 1px solid #e5e7eb; background:#fff; border-radius:12px; 
      box-shadow:0 2px 8px rgba(0,0,0,.06); padding:18px 18px;
    }
    .split {
      display:grid; grid-template-columns: 1.1fr 1.4fr; gap:24px; align-items:start;
    }
    .muted { color:#6b7280; }
    .help { font-size:.92rem; color:#6b7280; margin-top:6px; }
    .list-empty {
      border:2px dashed #e5e7eb; border-radius:12px; padding:18px; text-align:center; color:#6b7280;
    }
    .row {
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    /* Accessorials list (left aligned text + aligned delete buttons) */
    .accessorials-list { list-style:none; padding:0; margin:0; }
    .accessorials-item {
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #e5e7eb; padding:12px 8px;
    }
    .acc-info { display:flex; align-items:center; gap:10px; min-width:0; }
    .acc-name { font-weight:600; color:#0f3a29; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .acc-price { font-weight:600; color:#111827; }

    .btn-delete {
      background:#0f3a29; color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:600; cursor:pointer; display:inline-flex; 
      align-items:center; justify-content:center; transition:background .2s ease;
    }
    .btn-delete:hover { background:#145a3c; }

    /* Inline alerts */
    .msg { margin-top:10px; font-size:.95rem; }
    .msg.ok { color:#145a3c; }
    .msg.err { color:#b91c1c; }

    /* Mobile */
    @media (max-width: 960px) {
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <!-- Unified header (identical across pages) -->
  <header class="topbar">
    <div class="brand"><span class="brand-text">CW Czar Pricing</span></div>
    <nav class="topnav">
      <a href="index.html">Rate a Shipment</a>
      <a href="manage.html">Manage Settings</a>
      <a href="usage.html">Usage Report</a>
      <a href="accessorials.html" class="active">Accessorials</a>
    </nav>
    <div class="account">
      <a href="account.html" class="account-link">My Account</a>
    </div>
  </header>

  <main class="container">
    <h1 class="title-center">Accessorials</h1>
    <p class="page-intro">
      Save accessorials once and reuse them on the “Rate a Shipment” page. Your saved items are stored per user.
    </p>

    <div class="split" style="margin-top:28px;">
      <!-- Left: Create / Import -->
      <section class="card">
        <h3 style="margin:0 0 12px; color:#0f3a29;">Add a New Accessorial</h3>
        <form id="accessorialForm" novalidate>
          <label for="accName">Accessorial Name</label>
          <input id="accName" type="text" placeholder="e.g., Liftgate, Residential, Inside Delivery" autocomplete="off" />

          <label for="accPrice">Price ($)</label>
          <input id="accPrice" type="number" step="0.01" min="0" placeholder="e.g., 75.00" />

          <div class="actions">
            <button class="btn-primary" type="submit">Save Accessorial</button>
            <button class="btn-subtle" type="button" id="clearFormBtn">Clear</button>
          </div>
          <div id="formMsg" class="msg" aria-live="polite"></div>
        </form>

        <hr style="border:none;border-top:1px solid #e5e7eb;margin:20px 0;" />

        <h3 style="margin:0 0 10px; color:#0f3a29;">Bulk Import (optional)</h3>
        <p class="help">Paste one per line, format: <code>Name,Price</code> &nbsp; e.g. <code>Liftgate,75</code></p>
        <textarea id="bulk" rows="5" placeholder="Example:
Liftgate,75
Residential,35
Inside Delivery,45"></textarea>
        <div class="actions" style="margin-top:10px;">
          <button class="btn-subtle" type="button" id="bulkImportBtn">Import</button>
          <button class="btn-subtle" type="button" id="bulkClearBtn">Clear Text</button>
        </div>
        <div id="bulkMsg" class="msg" aria-live="polite"></div>
      </section>

      <!-- Right: List / Manage -->
      <section class="card">
        <h3 style="margin:0 0 12px; color:#0f3a29; display:flex; justify-content:space-between; align-items:center;">
          <span>My Saved Accessorials</span>
          <button class="btn-subtle" id="clearAllBtn" type="button" title="Delete all my accessorials">Delete All</button>
        </h3>

        <div id="listWrap">
          <div class="list-empty" id="emptyState">No saved accessorials yet.</div>
          <ul class="accessorials-list" id="accList" style="display:none;"></ul>
        </div>
        <p class="help" style="margin-top:12px;">Tip: On the Rate page, use “Select Saved Accessorial” to add these to a quote.</p>
      </section>
    </div>
  </main>

  <footer>© 2025 CW Czar Pricing. All Rights Reserved.</footer>

  <script type="module">
    // If you’re using auth.js elsewhere, you can require auth here as well:
    // import { requireAuth } from "./auth.js";
    // requireAuth();
  </script>

  <script>
    (function(){
      const $ = id => document.getElementById(id);

      // === PER-USER STORAGE KEYS (shared with index.html) ===
      const KEY_BASE = "CWCZAR_ACCESSORIALS";
      function getCurrentUserEmail(){
        try {
          const u = JSON.parse(localStorage.getItem("cwczar.user") || "null");
          return (u?.email || "anon").toLowerCase();
        } catch { return "anon"; }
      }
      function userKey(){ return `${KEY_BASE}:${getCurrentUserEmail()}`; }

      // === UTIL ===
      function toMoney(v){
        const n = parseFloat(String(v).replace(/[^0-9.\-]/g,""));
        return isNaN(n) ? 0 : n;
      }
      function loadSaved(){
        try { return JSON.parse(localStorage.getItem(userKey())) || []; }
        catch { return []; }
      }
      function saveList(arr){
        localStorage.setItem(userKey(), JSON.stringify(arr));
      }

      // === ELEMENTS ===
      const form = $("accessorialForm");
      const nameEl = $("accName");
      const priceEl = $("accPrice");
      const formMsg = $("formMsg");
      const clearFormBtn = $("clearFormBtn");

      const list = $("accList");
      const emptyState = $("emptyState");
      const bulk = $("bulk");
      const bulkImportBtn = $("bulkImportBtn");
      const bulkClearBtn = $("bulkClearBtn");
      const bulkMsg = $("bulkMsg");
      const clearAllBtn = $("clearAllBtn");

      // === RENDER LIST ===
      function render(){
        const items = loadSaved().sort((a,b) => a.name.localeCompare(b.name));
        list.innerHTML = "";
        if (!items.length){
          emptyState.style.display = "block";
          list.style.display = "none";
          return;
        }
        emptyState.style.display = "none";
        list.style.display = "block";

        for (const item of items){
          const li = document.createElement("li");
          li.className = "accessorials-item";

          const info = document.createElement("div");
          info.className = "acc-info";
          const name = document.createElement("div");
          name.className = "acc-name";
          name.textContent = item.name;

          const price = document.createElement("div");
          price.className = "acc-price";
          price.textContent = `$${Number(item.price).toFixed(2)}`;

          info.appendChild(name);
          info.appendChild(price);

          const del = document.createElement("button");
          del.className = "btn-delete";
          del.type = "button";
          del.textContent = "Delete";
          del.setAttribute("aria-label", `Delete ${item.name}`);
          del.addEventListener("click", () => {
            const remaining = loadSaved().filter(x => !(x.name === item.name && Number(x.price) === Number(item.price)));
            saveList(remaining);
            render();
          });

          li.appendChild(info);
          li.appendChild(del);
          list.appendChild(li);
        }
      }

      // === ADD SINGLE ===
      form.addEventListener("submit", (e)=>{
        e.preventDefault();
        formMsg.textContent = ""; formMsg.className = "msg";

        const name = (nameEl.value || "").trim();
        const price = toMoney(priceEl.value);

        if (!name){
          formMsg.textContent = "Please enter a name.";
          formMsg.classList.add("err");
          nameEl.focus();
          return;
        }
        if (price <= 0){
          formMsg.textContent = "Please enter a price greater than 0.";
          formMsg.classList.add("err");
          priceEl.focus();
          return;
        }

        const items = loadSaved();
        // If name exists, update its price; else push
        const i = items.findIndex(x => x.name.toLowerCase() === name.toLowerCase());
        if (i >= 0) items[i].price = Number(price);
        else items.push({ name, price: Number(price) });

        saveList(items);
        formMsg.textContent = i >= 0 ? "Accessorial updated." : "Accessorial saved.";
        formMsg.classList.add("ok");

        form.reset();
        nameEl.focus();
        render();
      });

      clearFormBtn.addEventListener("click", ()=>{
        form.reset();
        formMsg.textContent = "";
        nameEl.focus();
      });

      // === BULK IMPORT ===
      bulkImportBtn.addEventListener("click", ()=>{
        bulkMsg.textContent = ""; bulkMsg.className = "msg";
        const lines = (bulk.value || "").split(/\r?\n/).map(s => s.trim()).filter(Boolean);
        if (!lines.length){
          bulkMsg.textContent = "Nothing to import.";
          bulkMsg.classList.add("err");
          return;
        }
        let added = 0, updated = 0;
        const items = loadSaved();

        for (const line of lines){
          const parts = line.split(",").map(s => s.trim());
          if (parts.length < 2) continue;
          const nm = parts[0];
          const pr = toMoney(parts[1]);
          if (!nm || pr <= 0) continue;

          const idx = items.findIndex(x => x.name.toLowerCase() === nm.toLowerCase());
          if (idx >= 0){ items[idx].price = Number(pr); updated++; }
          else { items.push({ name: nm, price: Number(pr) }); added++; }
        }
        saveList(items);
        render();
        bulkMsg.textContent = `Imported: ${added} added, ${updated} updated.`;
        bulkMsg.classList.add("ok");
      });

      bulkClearBtn.addEventListener("click", ()=>{
        bulk.value = "";
        bulkMsg.textContent = "";
      });

      // === CLEAR ALL ===
      clearAllBtn.addEventListener("click", ()=>{
        if (!confirm("Delete all saved accessorials? This cannot be undone.")) return;
        saveList([]);
        render();
      });

      // Initial paint
      render();
    })();
  </script>
</body>
</html>
