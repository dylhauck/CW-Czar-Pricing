<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CW LTL Rate Base | Rate A Shipment</title>

  <link rel="stylesheet" href="./styles.css?v=25" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body { background:#f8faf9; font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0 }
    header.topbar{display:flex;justify-content:space-between;align-items:center;background:#0f3a29;color:#fff;padding:15px 40px}
    .brand-text{font-weight:700;font-size:1.25rem}
    .topnav a{margin-right:20px;color:#fff;text-decoration:none;font-weight:500}
    main.container{max-width:1100px;margin:60px auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);padding:40px 60px}
    .title-center{text-align:center;color:#0f3a29;font-weight:700;font-size:1.6rem;margin-bottom:30px}
    .rate-wrapper{display:flex;justify-content:center;align-items:flex-start;gap:60px;width:100%}

    .form-section{flex:1;max-width:420px;display:flex;flex-direction:column}
    label{font-weight:600;color:#111827;display:block;width:100%;margin-top:10px}
    input,select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;font-size:.95rem;margin-top:4px}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:20px;width:100%}
    .btn-primary{background:#0f3a29;color:#fff;border:none;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:600}
    .btn-subtle{background:#e9f5ec;color:#0f3a29;border:1px solid #c8dfd1;border-radius:8px;padding:10px 16px;cursor:pointer;font-weight:600}

    .right-col{flex:1;border-left:2px solid #d1d5db;padding-left:50px;margin-top:8px}
    .density-card{border:1px solid #e5e7eb;border-radius:12px;padding:14px 16px;margin-bottom:18px;background:#f8faf9}
    .density-card h3{margin:0 0 10px;font-size:1.05rem;color:#0f3a29}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .density-meta{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;font-weight:600;color:#0f3a29}
    .density-actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .density-note{color:#6b7280;font-size:.85rem;margin-top:6px}

    .results-list{list-style:none;padding:0;margin:0}
    .results-list li{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dotted #d1d5db;font-size:1rem}

    footer{text-align:center;color:#6b7280;font-size:.9rem;margin-top:50px;padding-bottom:20px}

    @media (max-width:900px){
      main.container{padding:30px}
      .rate-wrapper{flex-direction:column;gap:30px}
      .right-col{border-left:none;border-top:2px solid #d1d5db;padding-left:0;padding-top:20px}
      .grid-4{grid-template-columns:repeat(2,1fr)}
      .density-meta{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <header class="topbar">
  <div class="brand"><span class="brand-text">CW Czar Pricing</span></div>

  <nav class="topnav">
    <a href="index.html">Rate a Shipment</a>
    <a href="manage.html">Manage Settings</a>
    <a href="usage.html">Usage Report</a>
    <a href="accessorials.html">Accessorials</a>
  </nav>

  <div class="account">
    <a href="account.html" class="account-link">My Account</a>
  </div>
</header>

  <main class="container">
    <h2 class="title-center">Rate a Shipment</h2>

    <div class="rate-wrapper">
      <!-- LEFT FORM -->
      <section class="form-section">
        <label>Origin ZIP</label>
        <input id="originZip" type="text" placeholder="e.g., 30303" />

        <label>Destination ZIP</label>
        <input id="destZip" type="text" placeholder="e.g., 60606" />

        <label>Class</label>
        <input id="class" type="text" placeholder="e.g., 70" />

        <label>Weight (lb)</label>
        <input id="weight" type="text" placeholder="e.g., 500" />

        <label>Miles</label>
        <input id="miles" type="text" placeholder="optional" />

        <label>Fuel Surcharge (%)</label>
        <input id="fscPct" type="text" placeholder="e.g., 25" />

        <label>MC Floor ($)</label>
        <input id="mcFloor" type="text" placeholder="optional" />

        <label>Accessorials ($)</label>
        <input id="accessorials" type="text" placeholder="0.00" />

        <label>Select Saved Accessorial</label>
        <div style="display:flex;gap:8px;width:100%;">
          <select id="savedAccessorial" style="flex:1;"></select>
          <button id="addAccessorialBtn" type="button" class="btn-subtle">Add</button>
        </div>

        <div id="accChosen" style="margin:8px 0 4px;min-height:6px;"></div>

        <label>Discount (%)</label>
        <input id="discountPct" type="text" placeholder="e.g., 70" />

        <div class="actions">
          <button id="rateBtn" class="btn-primary">Rate Shipment</button>
          <button id="clearBtn" class="btn-subtle" type="button">Clear</button>
        </div>
      </section>

      <!-- RIGHT COLUMN -->
      <section class="right-col">
        <!-- Optional Density Inputs -->
        <div class="density-card" id="densityBox">
          <h3>Optional Density Inputs</h3>
          <div class="grid-4">
            <div><label for="densPallets">pallets</label><input id="densPallets" type="number" min="1" step="1" placeholder="e.g., 1" /></div>
            <div><label for="densLen">Length (in)</label><input id="densLen" type="number" step="0.01" placeholder="e.g., 48" /></div>
            <div><label for="densWid">Width (in)</label><input id="densWid" type="number" step="0.01" placeholder="e.g., 40" /></div>
            <div><label for="densHt">Height (in)</label><input id="densHt" type="number" step="0.01" placeholder="e.g., 60" /></div>
          </div>

          <div class="density-meta">
            <div>Cubic Ft: <span id="densCft">—</span></div>
            <div>Density (lb/ft³): <span id="densLbft">—</span></div>
            <div>Suggested Class: <span id="densClass">—</span></div>
          </div>

          <div id="densHint" class="density-note">Enter weight on the left to calculate density & class.</div>

          <div class="density-actions">
            <button class="btn-primary" id="useClassBtn" type="button" disabled>Use suggested class</button>
          </div>
        </div>

        <!-- Totals -->
        <ul class="results-list">
          <li><span>Gross</span><span id="tGross">—</span></li>
          <li><span>Discount</span><span id="tDisc">—</span></li>
          <li><span>MC Floor</span><span id="tFloor">—</span></li>
          <li><span>Fuel Surcharge</span><span id="tFsc">—</span></li>
          <li><span>Accessorials</span><span id="tAcc">—</span></li>
          <li><strong>Net</strong><strong id="tNet">—</strong></li>
        </ul>
      </section>
    </div>
  </main>

  <footer>© 2025 CW LTL Rate Base. All Rights Reserved.</footer>

  <script type="module">
    import { requireAuth, applyUserToUI } from "./auth.js?v=3";
    requireAuth();
    applyUserToUI();
  </script>
  <script src="./app.js?v=3"></script>

  <!-- Per-user Saved Accessorials -->
  <script>
  (function(){
    const $=id=>document.getElementById(id);
    const sel=$('savedAccessorial'),add=$('addAccessorialBtn'),acc=$('accessorials'),clr=$('clearBtn'),chips=$('accChosen');
    if(!sel||!add||!acc)return;

    const KEY_BASE='CWCZAR_ACCESSORIALS';
    function getCurrentUserEmail(){try{const u=JSON.parse(localStorage.getItem('cwczar.user')||'null');return(u?.email||'anon').toLowerCase();}catch{return'anon';}}
    function userKey(){return`${KEY_BASE}:${getCurrentUserEmail()}`;}
    function toNum(v){const n=parseFloat(String(v??'').replace(/[^0-9.\-]/g,''));return isNaN(n)?0:n;}
    function loadSaved(){try{return JSON.parse(localStorage.getItem(userKey()))||[];}catch{return[];}}

    function populate(){
      const items=loadSaved();
      sel.innerHTML='';
      if(!items.length){sel.innerHTML='<option value="">No saved accessorials</option>';return;}
      sel.insertAdjacentHTML('beforeend','<option value="">Choose…</option>');
      items.forEach(i=>{
        const o=document.createElement('option');
        o.value=i.name;o.textContent=`${i.name} ($${Number(i.price).toFixed(2)})`;o.dataset.price=i.price;
        sel.appendChild(o);
      });
    }

    const chosen=new Map();
    function renderChips(){
      chips.innerHTML='';
      chosen.forEach((price,name)=>{
        const chip=document.createElement('span');
        chip.style.cssText='display:inline-block;margin:2px 6px 0 0;padding:4px 8px;border:1px solid #c8dfd1;border-radius:999px;background:#eef6f1;color:#0f3a29;font-weight:600;cursor:pointer';
        chip.title='Remove';
        chip.textContent=`${name} ($${Number(price).toFixed(2)}) ×`;
        chip.addEventListener('click',()=>{chosen.delete(name);acc.value=(toNum(acc.value)-toNum(price)).toFixed(2);renderChips();});
        chips.appendChild(chip);
      });
    }

    add.addEventListener('click',()=>{
      const opt=sel.options[sel.selectedIndex];const name=opt?.value;if(!name)return;
      const price=toNum(opt.dataset.price);
      if(!chosen.has(name)){chosen.set(name,price);acc.value=(toNum(acc.value)+price).toFixed(2);renderChips();}
    });
    clr&&clr.addEventListener('click',()=>{chosen.clear();renderChips();});

    populate();renderChips();
  })();
  </script>

  <!-- Density Calculator -->
  <script>
    (function(){
      const $=id=>document.getElementById(id);
      const w=$('weight'),p=$('densPallets'),L=$('densLen'),W=$('densWid'),H=$('densHt');
      const cft=$('densCft'),den=$('densLbft'),cls=$('densClass');
      const hint=$('densHint'),useBtn=$('useClassBtn'),classInput=$('class');

      function toNum(v){const n=parseFloat(String(v??'').replace(/[^0-9.\-]/g,''));return isNaN(n)?0:n;}
      function classFromDensity(d){
        if (d < 1)   return "400";
        if (d < 2)   return "300";
        if (d < 4)   return "250";
        if (d < 6)   return "175";
        if (d < 8)   return "125";
        if (d < 10)  return "100";
        if (d < 12)  return "92.5";
        if (d < 15)  return "85";
        if (d < 22.5)return "70";
        if (d < 30)  return "65";
        if (d < 35)  return "60";
        if (d < 50)  return "55";
        return "50";
      }

      function setUseBtnEnabled(enabled){
        useBtn.disabled=!enabled;
        useBtn.style.opacity=enabled?'1':'.5';
        useBtn.style.cursor=enabled?'pointer':'not-allowed';
      }

      function calc(){
        const pallets=Math.max(1,Math.floor(toNum(p.value)||1));
        const len=toNum(L.value),wid=toNum(W.value),ht=toNum(H.value),weight=toNum(w.value);
        if(!len||!wid||!ht){
          cft.textContent="—";den.textContent="—";cls.textContent="—";
          if(hint)hint.textContent="Enter length, width, and height to begin.";
          setUseBtnEnabled(false);return;
        }
        const cubicFeet=(len*wid*ht*pallets)/1728;
        cft.textContent=cubicFeet.toFixed(2);
        if(!weight){
          den.textContent="—";cls.textContent="—";
          if(hint)hint.textContent="Enter weight on the left to calculate density & class.";
          setUseBtnEnabled(false);return;
        }
        const density=weight/cubicFeet;
        den.textContent=density.toFixed(2);
        const c=classFromDensity(density);
        cls.textContent=c;
        if(hint)hint.textContent="";
        setUseBtnEnabled(true);
      }

      ['input','change'].forEach(evt=>[w,p,L,W,H].forEach(el=>el&&el.addEventListener(evt,calc)));

      useBtn.addEventListener('click',()=>{
        const suggested=cls.textContent.trim();
        if(!suggested||suggested==="—")return;
        classInput.value=suggested;
        classInput.style.boxShadow='0 0 0 2px #c8dfd1 inset';
        setTimeout(()=>classInput.style.boxShadow='',350);
      });

      calc();
    })();
  </script>
</body>
</html>
