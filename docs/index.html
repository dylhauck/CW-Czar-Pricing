<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rate a Shipment | CW LTL Rate Base</title>

  <link rel="stylesheet" href="./styles.css?v=21" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background: #f8faf9;
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header.topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0f3a29;
      color: white;
      padding: 15px 40px;
    }

    .brand-text { font-weight: 700; font-size: 1.25rem; }
    .topnav a { margin-right: 20px; color: white; text-decoration: none; font-weight: 500; }

    main.container {
      max-width: 1100px;
      margin: 60px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      padding: 40px 60px;
    }

    /* shared centered title */
    .title-center {
      text-align: center;
      color: #0f3a29;
      font-weight: 700;
      font-size: 1.6rem;
      margin-bottom: 30px;
    }

    .rate-wrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 60px;
      width: 100%;
    }

    .form-section {
      flex: 1;
      max-width: 420px;
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      color: #111827;
      display: block;
      width: 100%;
      margin-top: 10px;
    }

    input, select {
      width: 100%;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.95rem;
      margin-top: 4px;
    }

    .actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      width: 100%;
    }

    .btn-primary {
      background: #0f3a29;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-subtle {
      background: #e9f5ec;
      color: #0f3a29;
      border: 1px solid #c8dfd1;
      border-radius: 8px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
    }

    .results-section {
      flex: 1;
      border-left: 2px solid #d1d5db;
      padding-left: 50px;
      margin-top: 8px;
    }

    .results-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .results-list li {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px dotted #d1d5db;
      font-size: 1rem;
    }

    footer {
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
      margin-top: 50px;
      padding-bottom: 20px;
    }

    @media (max-width: 900px) {
      main.container { padding: 30px; }
      .rate-wrapper { flex-direction: column; gap: 30px; }
      .results-section { border-left: none; border-top: 2px solid #d1d5db; padding-left: 0; padding-top: 20px; }
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand"><span class="brand-text">CW Czar Pricing</span></div>
    <nav class="topnav">
      <a href="index.html" class="active">Rate a Shipment</a>
      <a href="manage.html">Manage Settings</a>
      <a href="usage.html">Usage Report</a>
      <a href="accessorials.html">Accessorials</a>
    </nav>
  </header>

  <main class="container">
    <h2 class="title-center">Rate a Shipment</h2>

    <div class="rate-wrapper">
      <!-- LEFT FORM -->
      <section class="form-section">
        <label>Origin ZIP</label>
        <input id="originZip" type="text" placeholder="e.g., 30303" />

        <label>Destination ZIP</label>
        <input id="destZip" type="text" placeholder="e.g., 60606" />

        <label>Class</label>
        <input id="class" type="text" placeholder="e.g., 70" />

        <label>Weight (lb)</label>
        <input id="weight" type="text" placeholder="e.g., 500" />

        <label>Miles</label>
        <input id="miles" type="text" placeholder="optional" />

        <label>Fuel Surcharge (%)</label>
        <input id="fscPct" type="text" placeholder="e.g., 25" />

        <label>MC Floor ($)</label>
        <input id="mcFloor" type="text" placeholder="optional" />

        <label>Accessorials ($)</label>
        <input id="accessorials" type="text" placeholder="0.00" />

        <label>Select Saved Accessorial</label>
        <div style="display:flex;gap:8px;width:100%;">
          <select id="savedAccessorial" style="flex:1;"></select>
          <button id="addAccessorialBtn" type="button" class="btn-subtle">Add</button>
        </div>

        <div id="accChosen" style="margin:8px 0 4px;min-height:6px;"></div>

        <label>Discount (%)</label>
        <input id="discountPct" type="text" placeholder="e.g., 70" />

        <div class="actions">
          <button id="rateBtn" class="btn-primary">Rate Shipment</button>
          <button id="clearBtn" class="btn-subtle" type="button">Clear</button>
        </div>
      </section>

      <!-- RIGHT RESULTS -->
      <section class="results-section">
        <ul class="results-list">
          <li><span>Gross</span><span id="tGross">—</span></li>
          <li><span>Discount</span><span id="tDisc">—</span></li>
          <li><span>MC Floor</span><span id="tFloor">—</span></li>
          <li><span>Fuel Surcharge</span><span id="tFsc">—</span></li>
          <li><span>Accessorials</span><span id="tAcc">—</span></li>
          <li><strong>Net</strong><strong id="tNet">—</strong></li>
        </ul>
      </section>
    </div>
  </main>

  <footer>© 2025 CW LTL Rate Base. All Rights Reserved.</footer>

  <!-- Auth check -->
  <script type="module">
    import { requireAuth, applyUserToUI } from "./auth.js?v=3";
    requireAuth();
    applyUserToUI();
  </script>

  <!-- Your main pricing logic -->
  <script src="./app.js?v=3"></script>

  <!-- Per-user Saved Accessorials: populate dropdown, add chips, update totals -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const sel  = $('savedAccessorial');
    const add  = $('addAccessorialBtn');
    const acc  = $('accessorials');
    const clr  = $('clearBtn');
    const chips= $('accChosen');

    if(!sel || !add || !acc) return;

    const KEY_BASE = 'CWCZAR_ACCESSORIALS';
    function getCurrentUserEmail(){
      try{
        const u = JSON.parse(localStorage.getItem('cwczar.user') || 'null');
        return (u?.email || 'anon').toLowerCase();
      }catch{ return 'anon'; }
    }
    function userKey(){ return `${KEY_BASE}:${getCurrentUserEmail()}`; }

    function toNum(v){
      const n = parseFloat(String(v ?? '').replace(/[^0-9.\\-]/g,''));
      return isNaN(n) ? 0 : n;
    }
    function loadSaved(){
      try { return JSON.parse(localStorage.getItem(userKey())) || []; }
      catch { return []; }
    }

    function populate(){
      const items = loadSaved();
      sel.innerHTML = '';
      if(!items.length){
        sel.innerHTML = '<option value="">No saved accessorials</option>';
        return;
      }
      sel.insertAdjacentHTML('beforeend','<option value="">Choose…</option>');
      items.forEach(i => {
        const opt = document.createElement('option');
        opt.value = i.name;
        opt.textContent = `${i.name} ($${Number(i.price).toFixed(2)})`;
        opt.dataset.price = i.price;
        sel.appendChild(opt);
      });
    }

    const chosen = new Map(); // name -> price
    function renderChips(){
      chips.innerHTML = '';
      chosen.forEach((price, name) => {
        const chip = document.createElement('span');
        chip.style.cssText = 'display:inline-block;margin:2px 6px 0 0;padding:4px 8px;border:1px solid #c8dfd1;border-radius:999px;background:#eef6f1;color:#0f3a29;font-weight:600;cursor:pointer';
        chip.title = 'Remove';
        chip.textContent = `${name} ($${Number(price).toFixed(2)}) ×`;
        chip.addEventListener('click', () => {
          chosen.delete(name);
          acc.value = (toNum(acc.value) - toNum(price)).toFixed(2);
          renderChips();
        });
        chips.appendChild(chip);
      });
    }

    add.addEventListener('click', () => {
      const opt = sel.options[sel.selectedIndex];
      const name = opt?.value;
      if(!name) return;
      const price = toNum(opt.dataset.price);
      if(!chosen.has(name)){
        chosen.set(name, price);
        acc.value = (toNum(acc.value) + price).toFixed(2);
        renderChips();
      }
    });

    if(clr){
      clr.addEventListener('click', () => {
        chosen.clear();
        renderChips();
      });
    }

    populate();
    renderChips();
  })();
  </script>
</body>
</html>
